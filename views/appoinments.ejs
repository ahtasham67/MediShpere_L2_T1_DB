<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appoinments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap');
        *{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        header{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 100px;
            background:#a6c5eb;
            display: flex;
            justify-content: space-evenly;
            z-index: 99;
            align-items: center;
        }
        .logo{
            font-size: 2em;
            color: aliceblue;
            user-select: none;
        }

        .navigation a{
            position: relative;
            font-size: 1.3em;
            color: black;
            text-decoration: none;
            font-weight: 500;
            margin-left: 150px;
        }
        .navigation a::after{
            content: ' ';
            position:absolute;
            width: 100%;
            height: 3px;
            background: blue;
            border-radius: 5px;
            left:0px;
            bottom: -6px;
            transform: scaleX(0);
            transform-origin: right;
            transition: transform .5s;
        }
        .navigation a:hover::after{
            transform: scaleX(1);
        }
        .navigation .button-login{
            width: 130px;
            height: 50px;
            
            background: transparent;
            border: 2px solid aliceblue;
            outline: none;
            border-radius: 26px;
            cursor: pointer;
            font-size: 1.1em;
            color: blue;
            font-weight: 500;
            margin-left: 100px;
            transition: .5s;
            background-color: azure;
        }
        .navigation .button-login:hover{
            background: blue;
            color: whitesmoke;
        }
        body{
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* background: url('../../public/home.jpg') no-repeat;
            background-size: cover;
            background-position: center; */
            /* background: #dfe9f5 */
            background: #c3d0df
        }
        .timesection{
            margin-top: 10px;
        }
        .wrapper{
            margin-left: 0px;
            margin-right: 214px;
        }
        .doctorsname{
    padding: 10px;
    background-color:white;
    border: 1px solid #ddd;
    width: 1430px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;  
    border-radius: 20px;
  margin-left: 200px;
  margin-right: 24px;
    padding: 20px;

}
.dateandtime{
    margin-left:215px;
}
.datesection{
    padding: 10px;
    background-color: whitesmoke;
      border: 1px solid #ddd;
   width:270px;
    height: 400px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;  
    border-radius: 20px;
    margin-left: 24px;
    margin-top: 8px; 
    margin-right: 8px;
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid wheat;
    padding: 10px;
}
.timesection{
    padding: 30px;
    background-color: whitesmoke;
      border: 1px solid #ddd;
    width: 1140px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;  
    border-radius: 20px;
    margin-top: 8px; 
    margin-right: 15px;
    height: 400px;
     max-height: 400px;
      overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px; /* Optional: Add padding for better visibility */
        
}

.buttonandcapatimout{
    margin-left: 15px;
}
.buttonandcapalogin{
    margin-left: 15px;
}

.button-login{
    padding: 10px;
    width: 280px;
            height: 50px;
            background: transparent;
            border: 2px solid wheat;
            cursor: pointer;
            font-size: 1.3em;
            color: black;
            font-weight: 500;
            margin-left: 16px;
            transition: .5s;
            background-color: whitesmoke;
            border-radius: 9px;
            margin-top: 30px;
            margin-left: 30px;
}
.button-login:hover{
    background: rgb(193, 140, 42);
            color: black;
}
.button-capa{
    padding: 10px;
    width: 90px;
            height: 50px;
            background: transparent;
            border: 2px solid white;
            cursor: pointer;
            font-size: 1.3em;
            color: white;
            font-weight: 500;
            margin-left: 10px;
            transition: .5s;
            background-color: blue;
            border-radius: 9px;
            margin-top: 30px;
            margin-left: 0px;
}
.button-timout{
    padding: 10px;
    width: 280px;
            height: 50px;
            background: transparent;
            border: 2px solid white;
            font-size: 1.3em;
            color: black;
            font-weight: 500;
            margin-left: 16px;
            transition: .5s;
            background-color: whitesmoke;
            border-radius: 9px;
            margin-top: 30px;
            margin-left: 30px;
            cursor: not-allowed;
            background-color: rgb(94, 90, 90);

}

button-timout:hover{
    cursor: not-allowed;
}
.confirmm{
    height: 50px;
            background: transparent;
            border: 2px solid white;
            /* border: 2px solid wheat; */
            cursor: not-allowed;
            font-size: 1.3em;
            color: white;
            border-radius: 9px;
            font-weight: 500;
            margin-left: 140px;
            transition: .5s;
            padding-top: 12px;
            padding-bottom: 12px;
            width: 250px;
            background-color: #E8E4E4;
       
}

.dashboard{
    width: 160px;
    height: 900x;
    padding: 10px;
    background: transparent;
    border: 2px solid aliceblue;
    outline: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.1em;
    color: blue;
    font-weight: 500;
    margin-left: 85px;
    transition: .5s;
    background-color: azure;   
        }

    .day{
        padding: 6px;
        border-radius: 9px;
        margin-top: 7px;
        padding-left: 45px;
        padding-right: 45px;
        text-decoration: none;
        color: black;
        border: 1px solid wheat;

    }
.day:hover{
    background-color: #E8E4E4;

}
.day::after{
    background-color: blue;
}

    </style>
</head>
<body>
    <header>
        <img src="../../public/logo.jpg" width="50px" style="margin-right: 10px; border-radius: 9px;">
         <h2 class="logo">Medi<span style="color: blue;">Sphere</span></h2>
         <nav class="navigation">
             <a href="/consultation">Consultation</a>
             <a href="/diagonstics">Diagonstics</a>
             <a href="/doctors">Doctors</a>
             <% if(!user) {%>

                <button class="button-login" onclick="window.location.href = '/login';">login</button>
                <% } else {%>
                   <!-- <a href="/dashboard"><div class = 'button-login'><i class="fa-solid fa-user"></i></div></a> -->
                   <button class="dashboard" onclick="window.location.href = '/dashboard';"><i class="fa-solid fa-user" style="margin-right: 9px;"></i><%= user.username%></button>
                <% } %>
         </nav>
     </header>
    <% if(name.length > 0) {%>
     <div class="wrapper" style="margin-top: 35px;">

        <div class="doctorsname" style="display: flex; align-items: center; margin-left: 235px;">
           <p>Availabel time slots  of</p>
           <img src="https://doctime-core-ap-southeast-1.s3.ap-southeast-1.amazonaws.com/persons/123577/profile_photos/aLTRMjpgUgHcHTUaUyUdxXiDTZwsFrqCoxPOKQA3.jpg" alt = "doctors image" width="50px" style="margin-left: 70px;">
           <div class="nameandspe" style="margin-left: 20px;">
            <h3><%= name[0].FULLNAME %></h1>
            <p><span style="color: blue;"><%=name[0].SPECIALITY %></span></p>
           </div>
        </div>
        <div class="dateandtime" style="display: flex;">
            <div class="datesection" style="display: block; align-content: center;" >
                <% for(let i = 0;i <days.length;i++) {%>
                    <% console.log(days[i].DY) %>
                    <ul style="align-items: center; margin-left: 20px; margin-top: 26px;">
                        <% if(days1[i].DY == appointmentrenderdate) {%>
                        <a href="/doctors/appoinments/<%= name[0].ID %>?date=<%= days1[i].DY %>" class="day" style="background-color: blue; color: white;">

                            <% } else {%>

                                <a href="/doctors/appoinments/<%= name[0].ID %>?date=<%= days1[i].DY %>" class="day">
                                <% } %>

                            <span class="nav-item"><%= days[i].DY %></span>

                        </a>
                    </ul>
                   <% } %>

            </div>
            <div class="timeandconfirmwrapper" style="margin-left:0px;">

                <div class="timesection">
                    <h2 style="margin-left: 30px; justify-content: center;"> Select Your Appointment Time</h2><br>
                    <div class="appoinmentstime">
                        <% for(let index = 0;index<name.length;index++){ %>
                            
                            <% if(name[index].STATUS  == 1) {%>
                                <div class="buttonandcapatimout" style="display: inline-block;">
                                    <button class="button-timout" id = "time" data-info="<%= JSON.stringify({starttime:name[index].STARTTIME, endtime:name[index].ENDTIME,id:name[index].ID}) %>" data-button-id = '<%= index %>' data-check="available" ><%=  name[index].STARTTIME + ' - ' + name[index].ENDTIME%></button>
                                    <button class="button-capa"><%= name[index].CAPACITY %></button>
                                </div> 
        
                                <% } else {%>
                                    <div class="buttonandcapalogin" style="display: inline-block;">
                                        <button class="button-login" id = "time" data-info="<%= JSON.stringify({starttime:name[index].STARTTIME, endtime:name[index].ENDTIME,id:name[index].ID,capacity:name[index].CAPACITY,day:appointmentrenderdate,patient:name[index].PATIENT + 1,schedule:name[index].SCHID,patientid:user.id}) %>" data-button-id = '<%= index %>' data-check="available" ><%=  name[index].STARTTIME + ' - ' + name[index].ENDTIME%></button>
                                        <button class="button-capa" id = 'capa'><%= name[index].CAPACITY %></button>
                                    </div> 

                                   <% } %>
                          <% } %>                       
                    </div>
                </div>
                <div class="confirm" style="margin-top: 20px; margin-left: 740px;">
                    <button class="confirmm" id = 'confirm'>Confirm</button>
                 </div>
            </div>

        </div>

     </div>

     <% }else { %>
        <div class="noschedule">
            <i class="fa-9x fa-solid fa-calendar-xmark" style="font-size: 20rem; margin-left: 200px; margin-top: 60px;"></i>
            <h2 style="margin-left: 180px; margin-top: 10px;">No Schedule for this doctor</h2>
        </div>

        <% } %>





     <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
           let save = null;

            //let msg = null;
           const timebuttons1 = document.getElementsByClassName('buttonandcapalogin');

            socket.on('update',(msg) => {
                console.log("printing message");
                console.log("msg is ",msg);
                for(let i = 0;i < timebuttons1.length;i++){
                let res = JSON.parse((timebuttons1[i].getElementsByClassName('button-login')[0].getAttribute('data-info')));
                console.log("printing in loop")
                console.log(res);
                console.log(res.id,res.starttime)

                if(res.id == msg.id && res.starttime == msg.starttime && res.endtime == msg.endtime && msg.status){
                    console.log("here we are")
                    let prevcapa = Number(timebuttons1[i].getElementsByClassName('button-capa')[0].innerHTML)
                    prevcapa = prevcapa - 1;
                    timebuttons1[i].getElementsByClassName('button-capa')[0].innerHTML = prevcapa;
                    timebuttons1[i].getElementsByClassName('button-login')[0].style.background = "rgb(94,90,90)";
                    timebuttons1[i].getElementsByClassName('button-login')[0].style.cursor = "not-allowed";
                    timebuttons1[i].getElementsByClassName('button-login')[0].classList.add('button-timout');
                    timebuttons1[i].getElementsByClassName('button-login')[0].classList.remove('button-login');
                  //  timebuttons1[i].getElementsByClassName('button-capa')[0].innerHTML = prevcapa;
                    
                }
                else if(res.id == msg.id && res.starttime == msg.starttime && res.endtime == msg.endtime){

                    let prevcapa = Number(timebuttons1[i].getElementsByClassName('button-capa')[0].innerHTML)
                    prevcapa = prevcapa - 1;
                    timebuttons1[i].getElementsByClassName('button-capa')[0].innerHTML = prevcapa;
                }
             }
            })

            const timebuttons = document.getElementsByClassName('buttonandcapalogin');


 
             for(let i = 0;i < (timebuttons.length);i++){
                    timebuttons[i].getElementsByClassName('button-login')[0].addEventListener('click',() => {
                    save = timebuttons[i].getElementsByClassName('button-login')[0].getAttribute('data-info');
                    
                    console.log((JSON.parse(save)).capacity)
                   // console.log(save);
                    for(let j = 0;j<timebuttons.length;j++){
                        //timebuttons[j].classList.remove('active');
                        timebuttons[j].getElementsByClassName('button-login')[0].style.background = 'white';
                        timebuttons[j].getElementsByClassName('button-login')[0].style.color = 'black';
                    }
                    //timebuttons[i].classList.add('active')
                    timebuttons[i].getElementsByClassName('button-login')[0].style.background = 'blue';
                    timebuttons[i].getElementsByClassName('button-login')[0].style.color = 'white';
                    document.getElementById('confirm').style.cursor = 'pointer';
                    document.getElementById('confirm').style.background = 'blue';
                    document.getElementById('confirm').style.color = 'white'
                })
              //  }
             }

 


            const confirm = document.getElementById('confirm')
                confirm.addEventListener('click',() =>{

                var additionalInfo = JSON.parse(save);
                if((additionalInfo.capacity-1) == 0){
                    additionalInfo.status = 1;
                }
                console.log(additionalInfo);
                socket.emit('time',additionalInfo);
           fetch('/appointments/book', 
           {
               method: 'POST',
               headers:
                {
                  'Content-Type': 'application/json'
                },
              body: JSON.stringify(additionalInfo)

            })
           .then(response =>              
            { if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // Redirect manually
                window.location.href = response.url;
            })
           .then(data => {
           console.log('POST request successful', data);
 
           })
           .catch(error => 
           {
           console.error('Error sending POST request', error);
              
          });

})
             
    </script>
    <style>
        .active{
            background: blue;
            color:white
        }
    </style>
</body>
</html>